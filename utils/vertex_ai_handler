import json
import os
import re

def analyze_error(error_log, project_id, location="us-central1"):
    """Analyzes Spark errors using Gemini via Vertex AI."""
    try:
        import google.generativeai as genai
        from google.auth import default
        from google.auth.transport.requests import Request
        
        credentials, _ = default(scopes=['https://www.googleapis.com/auth/cloud-platform'])
        credentials.refresh(Request())
        
        os.environ['GOOGLE_GENAI_USE_VERTEXAI'] = 'True'
        os.environ['GOOGLE_CLOUD_PROJECT'] = project_id
        os.environ['GOOGLE_CLOUD_LOCATION'] = location
        
        genai.configure(credentials=credentials)
        model = genai.GenerativeModel('gemini-2.0-flash-exp')
        
        prompt = f"""Analyze this Spark error and return JSON:
{{"root_cause": "specific error", "fix_type": "CODE", "suggested_fix": "how to fix"}}

Error: {error_log[:2000]}"""

        response = model.generate_content(prompt, generation_config=genai.GenerationConfig(temperature=0.1, max_output_tokens=300))
        text = response.text.strip().replace("```json", "").replace("```", "").strip()
        
        json_match = re.search(r'\{[^}]+\}', text, re.DOTALL)
        if json_match:
            text = json_match.group(0)
        
        result = json.loads(text)
        if ".." in str(result):
            result["fix_type"] = "CODE"
        
        print(f"âœ“ AI Analysis: {result.get('root_cause', '')[:80]}")
        return result
    except Exception as e:
        print(f"AI error: {str(e)[:100]}")
        return {
            "root_cause": "Table name with double dots" if ".." in error_log else "Unknown error",
            "fix_type": "CODE" if ".." in error_log else "MANUAL",
            "suggested_fix": "Remove double dots from table names" if ".." in error_log else "Check logs"
        }

def suggest_fix(analysis_result):
    return analysis_result
